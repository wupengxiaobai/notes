# ca微信小程序

### 基本应用

**微信小程序(应用)**

- 结构 wxml

  - 遵循XML语法
  - 常用标签
    - <view> 类似 <div>
    - <text> 类似 <span>
    - <image> 类似 <img>
      - 图片在开发小程序项目的时候
        - 图片需要设置宽高(有默认宽高)
        - 图片需要设置缩放模式 mode='aspectFill'
    - <navigator> 类似 <a>
  - 常用组件 
    - swiper

- 样式 wxss

  - 尺寸单位	rpx (基于750分辨率自动计算)
  - 样式导入 `import "xxx.wxss"`

- 行为 js 

  - ECMAScript

  - wx对象(微信小程序封装的顶级对象)

    注意: 微信小程序里面没有 DOM 和 BOM 的概念

- 配置 json

  - 非常严格的 json 格式

  - **app.json 全局配置**

    - pages 配置路由

    - window 配置头部
    - tabBar 底部选项卡

**组件组成基本**

![1543578741889](.\wx\1543578741889.png)

#### wxml 高级

**数据绑定  `{{}}`**

```html
<!-- wxml -->
<view>{{message}}</view>
```

```js
//	page.js
Page({
    data: {
        message: "Hello wx!"
    }
})
```

**特别注意: **

1. 花括号和引号之间不能有空格
2. 不要直接写 checked="false", 其计算结果是一个字符串, 转成 boolean 类型后代表真值, 需要使用插值表达式来进行判断

```xml
<checkbox checked="{{false}}"></checkbox>
```

**列表渲染 wx:for='{{}}'**

```xml
<!-- wxml --> 
<view wx:for="{{array}}" wx:key="{{item.id}}">{{item}}</view>
```

```js
//	page.js
Page({
    data: {
        array: [1, 2, 3, 4, 520]
    }
})
```

**注意: 如果是多层嵌套情况, 使用  wx:for-item='xxx' 指定被遍历的每个item**

**流程判断 wx:if='{{}}'**

```xml
<!-- wxml --> 
<view wx:if="{{array}}">if</view>
<view wx:else="{{array}}">else</view>
```

**流程判断2 hidden="{{}}"**

**xml 中书写 js 代码**

```xml
<!-- wxml -->
<wxs module='foo'>
    //	这里可导出一个对象, 这个对象可以直接在界面上使用
    module.exports = {
            sum: function(a, b){
            return a + b;
        }
    }
</wxs>
<view>{{foo.sum(1,2)}}</view>
```

#### wxss 常用



#### 行为 js 文件

```js
/*
	此处可以是用来模块的引入和函数的封装
*/

Page({
    /**
   * 页面的初始数据
   */
    data: {},
    /**
   * 生命周期函数--监听页面加载
   */
    onLoad: function (options) {
        //	options.scene 可以识别用户通过什么方式进入我们的小程序
        //	我们需要请求过的数据, 在该生命周期进行请求相对合适
        //	使用 wx.require() 请求数据
        wx.request({
            url: 'https://locally.uieee.com/slides',
            data: '',
            header: {},
            method: 'GET',
            dataType: 'json',
            success: function(res) {},
            fail: function(res) {},
            complete: function(res) {},
        });
    },
    /**
   * 生命周期函数--监听页面初次渲染完成
   */
    onReady: function () {},
    /**
   * 生命周期函数--监听页面显示
   */
    onShow: function () {},
    /**
   * 生命周期函数--监听页面隐藏
   */
    onHide: function () {},
    /**
   * 生命周期函数--监听页面卸载
   */
    onUnload: function () {},
    /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
    onPullDownRefresh: function () {},
    /**
   * 页面上拉触底事件的处理函数
   */
    onReachBottom: function () {},
    /**
   * 用户点击右上角分享
   */
    onShareAppMessage: function () {}
})
```

##### **事件绑定和冒泡**

1. 冒泡事件 bind 事件类型 如 `bindtap` `bindlongpress`
2. 非冒泡事件 catch 事件类型 如 `catchtap` `catchlongpress`

**常用事件类型**

| 类型      | 触发条件                     |
| --------- | ---------------------------- |
| tap       | 手指触摸后马上离开           |
| longpress | 手指触摸后, 超过 350ms再离开 |



### 常用组件

#### 视图容器

##### View

|                        | 类型    | 默认值 | 说明                                                         |
| ---------------------- | ------- | ------ | ------------------------------------------------------------ |
| hover-class            | String  | none   | 指定按下(view)去的样式类, 当hover-class="none"时,没有点击效果 |
| hover-stop-propagation | Boolean | flase  | 指定是否组织本节点的祖先节点出现点击状态                     |
| hover-start-time       | Number  | 50     | 按住后多久出现点击状态, 单位毫秒                             |
| hover-stay-time        | Number  | 400    | 手指松开后点击状态保留时间, 单位毫秒                         |

##### scroll-view

| 属性              | 类型          | 默认值 | 说明                                                         |
| ----------------- | ------------- | ------ | ------------------------------------------------------------ |
| scroll-x/scroll-y | Boolean       | false  | 允许 横向/纵向 滚动                                          |
| upper-threshold   | Number/String | 50     | 设置距离顶部/左边多远时 触发 scrolltoupper 事件              |
| lower-threshold   | Number/String | 50     | 设置距离底部/右边多远时 触发 scrolltolower 事件              |
| bindscrolltoupper | EventHandle   |        | 滚动到顶部/左边, 会触发 scrolltoupper事件                    |
| bindscrolltolower | EventHandle   |        | 滚动到底部/右边, 会触发 scrolltlower                         |
| bindscroll        | EventHandle   |        | 滚动触发, event.detail={scrollLeft,scrollTop,scrollHeight,scrollWdith,deltaX,deltaY} |

![1544002774295](.\wx\1544002774295.png)

#### 基础内容

##### icon图标

| 属性名 | 类型          | 默认值 | 说明                                                         |
| ------ | ------------- | ------ | ------------------------------------------------------------ |
| type   | String        |        | icon的类型, 有效值: success, success_no_circle, info, warn, waiting, cancel, download, search, clear |
| size   | Number/String | 23px   | icon大小                                                     |
| color  | Color         |        | icon的颜色, 同css的color                                     |

##### text 组件

| 属性名     | 类型    | 默认值 | 说明                                                         |
| ---------- | ------- | ------ | ------------------------------------------------------------ |
| selectable | Boolean | false  | 文本是否可选                                                 |
| space      | String  | false  | 显示连续空格 有效值: ensp(中文字符空格一般大小),nbsp(根据字体设置的空格带小), emsp(中文字符空格大小) |
| decode     | Boolean | false  | 是否解码                                                     |

##### progress 进度条

| 属性            | 类型        | 默认值    | 说明                                                  |
| --------------- | ----------- | --------- | ----------------------------------------------------- |
| percent         | Float       |           | 百分比0~100                                           |
| show-info       | Boolean     | false     | 进度条右侧显示百分比                                  |
| border-radius   | Number      | 0         | 圆角大小                                              |
| font-size       | Number      | 16        | 右侧百分比字体大小                                    |
| stroke-width    | Number      | 6         | 进度条线的宽度                                        |
| color           | Color       | #09bb7    | 进度条颜色(请使用 activeColor)                        |
| activeColor     | Color       |           | 已选择的进度条的颜色                                  |
| backgroundColor | Color       |           | 未选择的进度条颜色                                    |
| active          | Boolean     | false     | 进度条从左往右的动画                                  |
| active-mode     | String      | backwards | backwards:动画从头播; forwards:动画从上次结束点接着播 |
| bindactiveend   | EventHandle |           | 动画完成事件                                          |

**注意: 在 mpVue 中使用进度条外包一个div**, 控制大小

#### 表单组件

```xml
<!--常用表单-->
<input type='text'>常用表单</input>

<!--复选框/组-->
<checkbox>复选框</checkbox>
<checkbox-group bindchange="checkboxHandler" data-参数名='参数值'>
    <!--给checkbox组添加修改事件, 并使用 data-参数名='参数值' 进行参数传递 -->
    <checkbox checked>撸码</checkbox>
    <checkbox>做菜</checkbox>
</checkbox-group>

<!--单选框/组-->
<radio>单选框</radio>
<radio-group>
    <radio checked value='male'>男</radio>
    <radio value='female'>女</radio>
    <radio disabled>保密</radio>
</radio-group>

<switch checked></switch>
```

**input的一些属性**

| 属性                                 | 类型        | 默认值 | 说明                                                         |
| ------------------------------------ | ----------- | ------ | ------------------------------------------------------------ |
| type                                 | String      | text   | 有效值: text/number/idcart/digit                             |
| password                             | Boolean     | false  | 是否为密码类型                                               |
| placeholder/placeholder-style(class) | String      |        | 输入款为空时占位符/占位符样式(样式类)                        |
| focus                                | Boolean     | false  | 自动焦点                                                     |
| auto-focus                           | Boolean     | false  | (讲讲废弃, 直接使用 focus) 自动聚焦, 拉起键盘                |
| bindinput                            | EventHandle |        | 键盘输入时触发 event.detail = {value, cursor, keyCode}，keyCode 为键值 |
| bindFocus                            | EventHandle |        | 输入框聚焦时触发                                             |
| bindblur                             | EventHandle |        | 输入款失去焦点时触发                                         |
| bindconfirm                          | EventHandle |        | 点击完成按钮时触发                                           |

```js
//	事件接收参数
checkboxHandler(e){
	console.log(e.detail);	//	获取表单值
    console.log(e.target.dataset['参数名']);	//	获取传递参数值
}
```

**mpVue中复选等**

![1544110339097](.\wx\1544110339097.png)

##### picker

支持五种选择器，通过mode来区分，分别是普通选择器，多列选择器，时间选择器，日期选择器，省市区选择器，默认是普通选择器。

**普通选择器: mode = selector**

| 属性名     | 类型               | 默认值 | 说明                                                         |
| ---------- | ------------------ | ------ | ------------------------------------------------------------ |
| range      | Array/Object Array | []     | mode 为 selector 或 multiSelector时, range 有效              |
| range-key  | String             |        | 当 range 是一个 Object Array 时, 通过 range-key 来选择器默认显示内容 |
| value      | Number             | 0      | 默认选择 range 中的第几个(下标0开始)                         |
| disabled   | Boolean            | false  | 是否禁用                                                     |
| bindchange | EventHandle        |        | value 改变时触发 change 事件, 通过 event.mp.detail.value/event.target/value 获取选择项对应索引 |
| bindcancel | EventHandle        |        | 取消选择或点遮罩层收齐 picker 时触发                         |

**多列选择器 mode = multiSelector**

| 属性名           | 类型                  | 默认值 | 说明                                                         |
| ---------------- | --------------------- | ------ | ------------------------------------------------------------ |
| range            | 二维数组/二维对象数组 | []     | 数组的每项表示每列的数据如[['a','b'],['c','d']]              |
| range-key        | String                |        | 当 range 是二维 Object Array时, 通过 range-key 来指定 Object 中 key 的值作为选择器显示内容 |
| value            | Array                 | []     | 每一项表示选择了 range 对应项中的第几个                      |
| bindchange       | EventHandle           |        | value 改变触发 cahnge 事件                                   |
| bindcolumnchange | EventHandle           |        | 某一列的值改变时触发 columnchange 事件                       |
| bindcancel       | EventHandle           |        | 取消选择时触发                                               |

**时间选择器: model = time**

**日期选择器: mode = date**

**省市区选择器: model=region**

注意: 在修改显示内容的时候要修改整个数组(使用setData)才能达到界面数据同时更新的效果

##### button

[参考](https://developers.weixin.qq.com/miniprogram/dev/component/button.html)

| 属性      | 类型    | 默认值  | 说明                                                   |
| --------- | ------- | ------- | ------------------------------------------------------ |
| type      | String  | default | default/primary/warn 只有defalut时才可以设置背景的颜色 |
| plain     | Boolean | false   | 按钮是否镂空, 背景色透明                               |
| loading   | Boolean | false   | 文字前是否带 loading 图标                              |
| open-type | String  |         | 微信开放能力(转发)                                     |
| disabled  | Boolean | false   | 是否禁止选中                                           |



#### swiper组件

```html
<swiper indicator-dots="{{indicatorDots}}"
  autoplay="{{autoplay}}" interval="{{interval}}" duration="{{duration}}">
  <block wx:for="{{imgUrls}}">
    <swiper-item>
      <image src="{{item}}" class="slide-image" width="355" height="150"/>
    </swiper-item>
  </block>
</swiper>
<button bindtap="changeIndicatorDots"> indicator-dots </button>
<button bindtap="changeAutoplay"> autoplay </button>
<slider bindchange="intervalChange" show-value min="500" max="2000"/> interval
<slider bindchange="durationChange" show-value min="1000" max="10000"/> duration
```



#### tabBar组件

属性说明: 

| 属性            | 类型     | 是否必填 | 默认值 | 描述                            |
| --------------- | -------- | -------- | ------ | ------------------------------- |
| color           | HexColor | 是       |        | tab 上的文字默认颜色            |
| selectedColor   | HexColor | 是       |        | tab上的文字选中时颜色           |
| backgroundColor | HexColor | 是       |        | tab 的背景色                    |
| borderStyle     | String   | 否       | black  | tabber上边款的颜色(black/white) |
| list            | Array    | 是       |        | tab的列表, 至少2个, 最多5个     |
| position        | String   | 否       | bootom | 可选值 bottom, top(无图标)      |

其中 list 接受一个数组, 数组中的每个项都是一个对象, 属性值如下

| 属性             | 类型   | 是否必填 | 说明                                                         |
| ---------------- | ------ | -------- | ------------------------------------------------------------ |
| pagePath         | String | 是       | 页面路径, 必须在pages中先定义                                |
| text             | String | 是       | tab上按钮文字                                                |
| iconPath         | String | 否       | 图片路径, icon 大小限制为40kb, 建议尺寸81px*81px(position 为 top时,该参数无效) |
| selectedIconPath | String | 否       | 选中时图片路径, 其它说明如上iconPath相同                     |



### 常用 API

#### 本地存储

- **设置本地存储** 

  - 同步设置 **`wx.setStorageSync(string key, Object data)`**

  - 异步设置 **`wx.setStorage(Object object)`**

    ```js
        wx.setStorage({
            key:"key",
            data:"value"
        })
    
        try {
            wx.setStorageSync('key', 'value')
        } catch (e) {}
    ```

- **获取本地存储** 

  - 异步获取 **`wx.getStorage(Object object)`** 

  - 同步获取 **`wx.getStorageSync(String)`**

    ```js
    wx.getStorage({
        key: 'key',
        success (res) {
            console.log(res.data)
        }
    })
    ```

#### 用户授权

**获取用户信息**

- **wx.getUserInfo()** 获取用户信息(调用前需要用户授权)

- 用户授权使用 button 组件 `<button open-type="getUserInfo" bindgetuserinfo="onGotUserInfo">获取用户信息</button>`

  mpVue 中授权演示如下: 

  ```html
  <button open-type="getUserInfo" @getuserinfo="handleGetUserInfo">授权登录</button>
  ```

  ```js
  handleGetUserInfo() {
      let _this = this;
      wx.getUserInfo({
          success(data) {	//	授权成功
              if (data.rawData) {
                  _this.isShow = true;
                  _this.userInfo = data.userInfo;
              }
          },
          fail(data) {	//	授权失败
              wx.showToast(
                  {
                      title: "授权失败",
                      icon: "none"
                  },
                  1500
              );
              _this.isShow = false;
          }
      });
  }
  ```

#### 加载动画

**头部加载动画**

- **wx.showNavigationBarLoading(Object object)** 开始

- **wx.hideNavigationBarLoading(Object object)** 关闭

**提示框加载动画**

- **wx.showLoading(Object object)**	开启
- **wx.hideLoading(Object object)**     关闭

**提示框**

- **wx.showToast(Object object)** 
- **wx.hideToast(Object object)**

#### **下拉事件监听**

- **wx.startPullDownRefresh(Object object)** 开启(或者 window 配置 enablePullDownRefresh 为true即可)
- **wx.stopPullDownRefresh(Object object)** 关闭

#### 媒体相关

#### 背景音乐

- 音乐播放 **`wx.playBackgroundAudio(Object object)`**
- 音乐暂停 **`wx.pauseBackgroundAudio(Object object)`**

**音乐播放/暂停监听**

- 监听音乐播放 **`wx.onBackgroundAudioPlay(function callback)`**
- 监听音乐暂停 **`wx.onBackgroundAudioPause(function callback)`**
- 监听音乐停止 **`wx.onBackgroundAudioStop(function callback)`**

#### 显示操作菜单

- **wx.showActionSheet(Object object)**

| 属性      | 类型     | 默认值 | 描述                            |
| --------- | -------- | ------ | ------------------------------- |
| itemList  | Array    |        | 按钮的文字数组, 数组长度最大为6 |
| success   | function |        | 接口调用成功的回调函数          |
| fail      | function |        | 接口调用失败的回调函数          |
| itemColor | string   |        | 按钮文字颜色                    |

**object.success** 参数

| 属性     | 类型   | 说明                                  |
| -------- | ------ | ------------------------------------- |
| tapIndex | number | 用户点击的按钮序号, 从上到下, 从0开始 |

```js
wx.showActionSheet({
    itemList: ['A', 'B', 'C'],
    success (res) {
        console.log(res.tapIndex)
    },
    fail (res) {
        console.log(res.errMsg)
    }
})
```

#### 上传/下载

**下载** 

`wx.downloadFile(Object object)`

| 属性     | 类型     | 说明                                        |
| -------- | -------- | ------------------------------------------- |
| url      | string   | 下载资源的url(必填)                         |
| header   | Object   | HTTP请求的 Header, Header中不能设置 Referer |
| filePath | string   | 指定文件下载后存储的路径                    |
| success  | function | 成功回调                                    |
| fail     | function | 失败回调                                    |

**object.success 回调函数参数**

| tempFilePath | 临时文件路径, 如果没有传入filePatch 指定临时文件, 则下载后的文件会存储到一个临时文件 |
| ------------ | ------------------------------------------------------------ |
| statusCode   | 开发者服务区返回的 HTTP 状态码                               |

**返回值**

`DownloadTask`	 一个可以监听下载进度变化的事件

**上传相关**

**chooseImage** 接口获取到一个本地资源的临时文件路径后, 可以通过此接口将本地资源上传到指定服务器.

| count      | number   | 9                          | 最多可以选择的图片张数             |
| ---------- | -------- | -------------------------- | ---------------------------------- |
| sizeType   | Array    | ['original', 'compressed'] | 所选图片尺寸(原图/压缩图)          |
| sourceType | Array    | ['album', 'camera']        | 所选图片来源(从相册选图, 使用相机) |
| success    | function |                            | 成功回调                           |

success 回调参数

| tempFilePaths | Array | 图片的本地临时文件路径列表 |
| ------------- | ----- | -------------------------- |
| tempFiles     | Array | 图片的本地临时文件列表     |



**uploadFile(Object)** 文件上传 将本地资源上传到开发者服务器,. 客户端发起一个 HTTPS POST请求, 其中 content-type为 multipart/form-data

| url      | String   | 必须 | 开发者服务器url                                              |
| -------- | -------- | ---- | ------------------------------------------------------------ |
| filePath | String   | 必须 | 要上传你文件资源的路径                                       |
| name     | String   | 必须 | 文件对应的 key, 开发者在服务器端通过key可以获取到文件的二进制内容 |
| header   | Object   |      | HTTP 请求 Header, header 中不能设置 Refere                   |
| success  | Function |      | 接口调用成功的回调函数                                       |

```js
wx.chooseImage({
    count: 9,
    sizeType: ["original", "compressed"], //  尺寸
    sourceType: ["album", "camera"], //  来源
    success: res => {
        let [tempFilePaths, tempFiles] = [res.tempFilePaths, res.tempFiles];
        this.uploadImageArr = this.uploadImageArr.concat(tempFilePaths);	
        //  tempFilePaths 就是本地存储图片的临时路径, 此处做保存, 用于方便遍历显示到界面上

        //  执行上传值服务端
        /* const uploadTask = wx.uploadFile({
            url: "http://example.weixin.qq.com/upload", // 仅为示例，非真实的接口地址
            filePath: tempFilePaths[0],
            name: "file",
            formData: {
              user: "test"
            },
            success(res) {
              const data = res.data;	//	服务器返回的数据
              const statusCode = res.statusCode	//	服务器返回http状态码
              // do something
            }
          });
          uploadTask.onProgressUpdate(res => {
            console.log("上传进度", res.progress);
            console.log("已经上传的数据长度", res.totalBytesSent);
            console.log(
              "预期需要上传的数据总长度",
              res.totalBytesExpectedToSend
            );
          }); */
    },
    fail() {}
});
```

### 常用封装

#### js的封装

**请求的封装**

```js
//  请求封装
module.exports = function(url, method, data) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: url,
      data: data,
      method: method,
      header: {
        "Content-Type": 'json'
      },
      dataType: 'json',
      success: resolve,
      fail: reject
    })
  })
}
```

#### css 封装

```css

```



# 小程序API*

## 基础

### wx.canIUse(string schema)

判断小程序的API, 回调,参数,组件等是否在当前版本可用

- `${API}.${method}.${param}.${options}` 或者 `${component}.${attribute}.${option}` 

  参数说明:  

  - ${API} 代表 API 名字

  - ${method} 代表调用方式, 有效值为 return, success, object, callback

  - $(param) 代表参数或者返回值
  - ${options} 代表参数的可选值

  - ${component} 代表组件名字

  - ${attribute} 代表组件熟悉

  - ${option} 代表组件熟悉的可选值

  示例  `wx.canIUse('showToast.object.image')`

###系统

##### wx.getSystemInfoSync

##### wx.getSystemInfo

获取客户端系统信息, 返回值如下

| brand/model              | string | 手机品牌/型号     |
| ------------------------ | ------ | ----------------- |
| pixelRatio               | number | 设备像素比        |
| screenWidth/screenHeight | number | 屏幕宽度/高度     |
| windowWidth/windowHeight | number | 可使用窗口宽/高度 |
| language                 | string | 微信设置的语言    |
| version                  | string | 微信版本号        |
| system                   | string | 操作系统版本      |
| platform                 | string | 客户端平台        |

### 更新

##### wx.getUpdateManager()

获取**全局唯一**的版本更新管理器，用于管理小程序更新

##### UpdateManager

用来管理更新, 可以通过 wx.getUpdateManager 接口获取实例

方法如下: 

 -	UpdateManager.applyUpdate() 强制小程序重启并使用新版本.  下载完成(onUpdateReady 回调) 调用
	-	UpdateManager.onCheckForUpdate(callback) 监听像微信后台请求检查更新结果事件. 小程序启动时自动检查更新, 无需主动调用
			UpdateManager.onUpdateReady(callback) 小程序下载成功后回调
		UpdateManager.onUpdateFailed(callback) 小程序更新失败回调

```js
//  更新唯一凭证
let updateManager = wx.getUpdateManager()
// 查看是否有新版本
updateManager.onCheckForUpdate((res) => {
    console.log(res.hasUpdate)
})
//  有新版本则自动触发
updateManager.onUpdateReady(() => {
    wx.showModel({
        title: '更新提示',
        content: '新版本已准备哈, 是否重启',
        success(res) {
            if (res.confirm) {
                //  强制小程序重启使用新版
                updateManager.applyUpdate()
            }
        }
    })
})
//  更新失败回调
updateManager.onUpdateFailed(function() {
    console.log('更新失败')
})
```

### 小程序

#### 生命周期 

###### wx.getLaunchOptionsSync

获取小程序启动时的参数, 返回值 Object(启动参数)

| path         | string | 启动小程序的路径                                             |
| ------------ | ------ | ------------------------------------------------------------ |
| scene        | number | 启动小程序的场景值(1020 公众号profile页相关小程序列表, 1035公招自定义菜单, 1036 App分享卡片, 1037小程序打开小程序, 1038 从另一个小程序返回, 1043 公众号模板消息) |
| query        | Object | 启动小程序的 query 参数                                      |
| shareTicket  | string |                                                              |
| referrerInfo | Object | 来源信息. 从另一个小程序, 公众号或 App进入小程序时返回. 否则为 {} (appId 来源的 appId; extraData 来源的小程序传来的数据, scene=1037/1038时支持) |

#### 应用级别事件

###### wx.offPageNotFound(callback)

取消监听小程序要打开的页面不存在事件

callback 打开的页面不存在事件的回调函数

###### wx.onPageNotFound(callback)

监听小程序要打开页面不存在事件

callback 小程序打开的页面不存在事件的回调函数

**注意: 我们可以在回调中使用页面重定向, 但是必须在回调中同步处理**

###### wx.offError(callback)

取消监听小程序错误事件, callback 错误事件的回调

###### wx.onError(callback)

监听小程序错误事件. 如脚本错误或 API 调用报错等. 改时间与 App.onError 的回调时机与参数一致

callback 回调函数, 参数 error 错误信息, 包含堆栈

###### wx.offAppShow(callback)

取消件套小程序切前台事件

###### wx.onAppShow(callback)

监听小程序切前台事件. 改时间与 App.onShow 回调参数一致

参数 res 结构

| path         | string | 小程序切前台的路径                                           |
| ------------ | ------ | ------------------------------------------------------------ |
| scene        | number | 小程序切前台的场景值                                         |
| query        | Object | 小程序切前台的query参数                                      |
| shareTicket  | string | 更多转发信息                                                 |
| referrerInfo | Object | 来源信息(appId 来源 的appId; extraData 来源传递来的数据. scene=1037/1038时支持) |

部分版本在无 referrerInfo 的时候会返回 undefined, 使用 `options.referrerInfo && options.referrerInfo.appId` 进行判断

###### wx.offAppHide(callback)

取消监听小程序切后台事件, 回调

###### wx.onAppHide(callback)

监听小程序切后台事件, 与 App.onHide 回调时机一致.

### 定时器

##### setTimeout(callback, number delay, any rest)

设定一个定时器, 在定时到期以后执行注册的回调函数

参数

​	callback  回调函数

​	number delay 延迟时间, 单位ms

​	any rest 附加参数, 作为参数传递给回调函数

返回值 number 定时器的编号, 该值传递给 clearTimeout 来取消定时器

##### clearTimeout(timeoutID)

取消由 setTimeout 设置的定时器

##### setInterval()

设定一个定时器, 按照指定的周期来执行注册回调

##### clearInterval()

取消由 setInterval 注册的定时器

### 调试

##### wx.setEnableDebug(Object object)

设置是否打开调试开. 

- enableDeBug 是否打开调试
- success 成功回调函数
- ...

##### wx.getLogManager(number level)

获取日志管理器对象.

- number level 取值 0/1, 取值为0表示会把 APP, Page 的生命周期函数和 wx命名空间下的函数调用写入入职, 取1则不会, 默认 0.

###### 返回值

LogManager 日志管理器实例

​	方法

 - LogManager.debug() 写 debug 日志
 - LogManager.info() 写 info 日志
 - LogManager.log() 写 log 日志
 - LogManager.warn() 写 warn 日志

使用说明 最多保存 5M 的日志内容, 超过旧内容会被删除.

用户可以通过使用 \<Button\> 组件的 open-type='feedback' 来上传打印的日志. 开发者可以通过小程序管理后台左侧菜单 "客服反馈" 页面查看

基础库默认把 App, Page 的生命周期函数和 wx 命名空间下的函数调用写入日志

#### 云开发控制台 console

云开发提供了一个控制台用于可视化管理云资源, 控制台包含以下几大模块

- 概览: 查看云资源的总体使用情况
- 用户管理: 查看小程序的用户访问记录
- 数据库: 管理数据库集合, 记录, 权限设置, 索引设置
- 存储管理: 管理云文件, 权限设置
- 云函数: 管理云函数, 查看调用日志. 监控记录
- 统计分析: 查看云资源详情使用统计

在用户管理中会显示使用云能力的小程序的访问用户列表, 默认以访问时间倒序排列, 访问时间的触发点是在小程序端调用 wx.cloud.init 方法, 其中 traceUser 参数值为 true  

```js
wx.cloud.init({
    traceUser: true
})
```



## 路由

#### wx.navigateBack(Object object)

- delta 回退多少步数, 超过步数则回到index
- success 成功回调

#### wx.navigateTo(Object object)

- url 跳转地址
- success 成功回调
- ...

#### wx.reLaunch(Object object)

关闭所有页面并指定跳转某页面

- url 指定跳转页面地址
- success 成功回调

#### wx.redirect(Object object)

关闭当前页面,并指定跳转某一页面

- url 跳转页面地址
- success 成功回调

#### wx.switchToTab(Object object)

指定跳转某一 tabBar 项

- url 指定跳转 tabBar 地址



## 界面

### 交互

##### wx.showLoading(Object object)

- title 加载提示
- mask 是否涵盖隐藏层, 默认false
- success 成功回调

##### wx.hideLoading() 加载

关闭加载loading

##### wx.showToast(Object object) 轻提示

- title 提示内容
- icon 提示体表
- mask 是否涵隐藏层

##### wx.hideToast() 隐藏轻提示

- success 成功回调
- ...

##### wx.showModel(Object object) 模态框

- title 标题
- content 内容
- cancelText 取消文本
- cancelColor 取消文本字体颜色
- confirmText 确认文本
- confirmColor 确认文本字体颜色
- success() 成功回调
  - 参数 res 根据res, 是可以确定点击了取消还是点击了确认

##### wx.showActionSheet(Object object)

显示操作菜单

- itemList 操作列表项
- success 成功回调 参数 res.tapIndex 选择菜单项索引

### 导航栏

##### wx.hideNavigationBarLoading(Object object)

当前页面隐藏导航条加载动画

- success 成功回调
- ...

##### wx.setNavigationBarColor(Object object)

设置页面顶部导航颜色

- fontColor 前景颜色值(按钮, 标题, 状态栏颜色, 支持 #ffffff, #000000)
- backgroundColor 背景颜色值, 有效值为十六进制颜色
- animation 动画效果
  - duration 动画变化时间, 默认0
  - timingFunc 动画变化方式, 默认 linear
    - linear easeIn easeOut easeInOut
- success 成功回调

##### wx.setNavigationBarTitle(Object object)

设置当前页面顶部导航标题

- title 标题文本
- success 成功回调
- ....

##### wx.showNavigationBarLoading()

在当前页面显示导航条加载动画

- success 成功回调

### 背景

##### wx.setBackgroundColor(Object object)

动态设置窗口的背景色

- backgroundColor 窗口的背景色, 必须是十六进制
- success 成功回调

##### wx.setBackgroundTextStyle(Object object)

动态设置下拉背景字体, loading 图的演示

- textStyle 必填 下拉背景字体, loading 样式
  - dark	
  - light

### Tab Bar

##### wx.hideTabBar(Object object)

隐藏 tabBar

- animation 是否需要动画效果, 默认false
- success 成功回调
- ...

##### wx.showTabBar(Object object)

显示 tabBar

- animation 是否需要动画效果, 默认false
- success 成功回调
- ...

##### wx.setTabBarStyle(Object object)

动态设置 tabBar 的整体样式

- color	tab文字默认颜色HexColor
- selectedColor      tab被选中时文字颜色HexColor
- backgroundColor     tab的背景色HexColor
- borderStyle   tabBar上边框的颜色, 支持 black/white
- success  成功回调
- ...

##### wx.setTabBarItem(Object object)

动态设置 tabBar 某一项的内容

- index tabBar 项目索引
- text    tab 上的按钮文字
- iconPtah  图片路径, 大小限制 40kb, 建议尺寸 81px*81px, 不支持网络图片
- selectedIconPath 选中时图片路径
- success  接口调用成功的回调函数
- ..

##### wx.showTabBarRedDot(Object object)

显示 tabBar 某一项的右上角的红点

- index 索引
- success 成功回调
- ....

##### wx.hideTabBarRedDot(Object object)

隐藏 tabBar 某一项右上角红点

- index 索引
- success 成功回调
- ....

##### wx.setTabBarBarBadge(Object object)

给 tabBar 某一项右上角添加文本

- index	索引	
- text        文本内容

##### wx.removeTabBarBadge(Object object)

移除 tabBar 某一项右上角的文本

- index 索引
- success 成功回调
- ...

### 下拉刷新

##### wx.startPullDownRefresh(Object object)

开始下拉刷新. 调用后出发下拉刷新动画, 效果与用户手动刷新一致

- success 成功回调

##### wx.stopPullDownRefresh()

停止当前页面下拉刷新

- success 成功回调

### 滚动

##### wx.pageScrollTo(Object object)

将页面滚动到目标位置

- scrollTop 滚动到页面的目标位置, 单位 px
- duration 滚动动画的时长, 单位 ms
- success 成功回调
- ...

### 动画

##### wx.createAnimation(Object object)

创建一个动画实例 animation. 调用实例的方法来描述动画, 最后通过动画实例的 export 方法导出动画数据传递给组件的 animation 属性

- duration 动画持续时间
- timingFunction 动画的效果, 默认 linear
- delay 延迟时间
- transformOrigin '50% 50% 0' 动画开始基点

###### 返回值  Animation

动画对象

- Animation.export() 导出动画队列

  export 方法每次调用后会清掉之前的动画操作

-  Animation.step() 表示一组动画完成.

  可以在一组动画中调用任意多个动画方法, 一组动画的所有动画会同时开始, 一组动画完成后才会进行下一组动画的开始.

#### 自定义组件

##### wx.nextTick(callback)

延迟一部分操作到下一个时间片再执行

#### 菜单

##### wx.getMenuButtonBoundingClientRect()

获取菜单按钮布置信息

#### 置顶

##### wx.setTopBarText(Object object)

动态设置置顶栏文字内容. 只有当前小程序被置顶时能生效.

- text 文本内容
- success 成功回调

### 窗口

##### wx.offWindowResize(callback)

取消监听窗口尺寸变化事件

- callback 尺寸变化事件回调

##### wx.onWindowResize(callback)

监听窗口尺寸变化

- callback 
  - 参数 res.size 
    -  windowWidth
    -  windowHeight

## 网络

### 发起请求

##### wx.request(Object object)

- url 开发者服务器地址
- data 请求参数
- header 设置请求头 默认 application/json
- method 请求方法 默认 get
  - OPTIONS HTTP 请求 OPTIONS
  - GET  HTTP请求GET
  - HEAD  HTTP请求 HEAD
  - POST HTTP 请求 POST
  - ... 
- dataType 返回数据格式
  - json 返回的数据为 JSON , 返回后会对数据进行一次 JOSN.parse
  - 其它  不对返回的内容进行 JSON.parse
- responseType 响应数据类型
  - text	响应的数据为文本
  - arraybuffer 响应的数据为 ArrayBuffer
- success 成功回调
  - data  开发者服务返回的数据
  - statusCode 开发者服务器返回的 HTTP 状态码
  - header 开发者服务器返回的 HTTP Response Header
- ...

data 参数说明

最终发送给服务器的数据是 String类型, 如果传入的data不是String, 会被转换, 规则如下:

- GET 方法的数据, 转成 query (q=xx&m=xxx&..)
- POST 方法且header['content-type']为 application/json 的数据, 会对数据进行 JSON 序列化
- POST 方法且 header['content-type'] 为 application/x-www-form-urlencoded 的数据, 会将数据转换成 query(encodeURIComponent(k)=encodeURIComponent(v)&encodeURIComponent(k)=encodeURIComponent(v)..)

示例代码

```js
let RequestTask = wx.request({
    url: 'test.php', // 仅为示例，并非真实的接口地址
    data: {
        x: '',
        y: ''
    },
    header: {
        'content-type': 'application/json' // 默认值
    },
    success(res) {
        console.log(res.data)
    }
})
```

返回值 RequestTask

- RequestTask.abort() 

  中断请求任务

- onHeadersReceived(callback)

  监听 HTTP Response Header 事件, 比请求完成事件更早

- offHeadersReceived(callback) 取消监听

### 下载

##### wx.downloadFile(Object object)

下载文件资源到本地. 客户端直接发起一个 HTTPS GET请求, 返回文件的本地临时路径

注意: 请在服务端响应的 header 中指定合理的 Content-Type 字段, 以保证客户端正确处理文件类型

- url 下载资源的URL路径
- header HTTP请求的 Header, Header中不能设置 Referer
- filePath 指定文件下载后存储的路径
- success 成功回调
  - tempFilePath  临时文件路径, 如果没有传入 filePath 指定文件存储路径, 则下载后的文件会存储到一个临时文件
  - statusCode 开发者服务器返回的 HTTP 状态码
- ....

###### 返回值 DownloadTask

一个可以监听下载进度变化事件和取消下载的对象

- DownloadTask.abort() 中断下载任务
- DownloadTask.onProgressUpdate(callback) 监听下载进度变化事件

​	callback 返回值 res

​	- progress 下载进度百分比

​	- totalBytesWritten 已经下载的数据长度, 单位 bytes

​	- totalBytesExpectedToWrite 预期需要下载的数据总长度, 单位 Bytes

```js
let DownloadTask = wx.downloadFile({
    url: 'https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1545303501290&di=fdd08c353d8c0c4c44afca807aa9a1d7&imgtype=0&src=http%3A%2F%2Fpic.58pic.com%2F00%2F95%2F76%2F78bOOOPIC49.jpg',
    success: (res) => {
        if (res.statusCode == 200) {
            console.log(res.tempFilePath)
            this.setData({
                'imgUrl': res.tempFilePath
            })
        }
    }
})
RequestTask.onProgressUpdate(function(res) {
    console.log(res)
})
```

- onHeadersReceived(callback)

监听 HTTP Response Header 事件. 比请求完成事件更早

参数 res.http 属性是开发者服务区返回的 HTTP Response Header

### 上传

##### wx.uploadFile(Object object)

将本地资源上传到服务器. 客户端发起一个 HTTPS POST 请求, 其中 content-type 为 multipart/form-data

- url	开发者服务区地址
- filePath 要上传文件资源路径
- name 文件对应的key, 开发者在的服务端可以通过 key 获取文件的二进制内容
- header HTTP 请求 Header
- formData HTTP 请求中其他额外的 form data
- success 成功回调
  - res.data 开发者服务区返回的数据
  - res.statusCode 开发者服务区返回的 HTTP 状态码
- ...

示例代码

```js
wx.chooseImage({
    success(res) {
        const tempFilePaths = res.tempFilePaths
        wx.uploadFile({
            url: 'https://example.weixin.qq.com/upload', // 仅为示例，非真实的接口地址
            filePath: tempFilePaths[0],
            name: 'file',
            formData: {
                user: 'test'
            },
            success(res) {
                const data = res.data
                // do something
                }
        })
    }
})
```

###### 返回值 UploadTask

UploadTask 一个可以监听上传进度的事件和取消上传的对象

- UploadTask.abort() 中断上传任务

- UploadTask.onProgressUpdate(callback)

  监听上传进度变化事件

- UploadTask.offProgressUpdate(callback)

  取消监听上传进度条变化事件
- UploadTask.onHeadersReceived(callback)

  监听 HTTP Response Header 事件, 比请求完成事件更早

```js
uploadTask.onProgressUpdate((res) => {
    console.log('上传进度', res.progress)
    console.log('已经上传的数据长度', res.totalBytesSent)
    console.log('预期需要上传的数据总长度', res.totalBytesExpectedToSend)
})

uploadTask.abort() // 取消上传任务
```

### WebSocket

##### wx.connectSocket(Object object)

创建一个 WebScoket 连接

- url  开发者服务器 wss 接口地址
- header 请求头设置
- protocols 子协议数组

- success 成功回调
- ...

###### 返回值 SocketTask

WebSocket 任务管理, 可以通过 wx.connectSocket() 接口创建返回

方法

- SocketTask.send(Object object) 通过 WebSocket 连接发送数据
- SocketTask.close(Object object) 关闭 WebSocket 连接
- SocketTask.onOpen(callback) 监听 WebSocket 连接打开事件
- SocketTask.onClose(callback) 监听 WebSocket 连接关闭事件
- SocketTask.onError(callback) 监听 WebSocket 错误事件
- SocketTask.onMessage(callback) 监听 WebSocket 接收到服务器的消息事件

##### wx.onSocketError(callback)

监听 WebSocket 错误事件

- callback WebSocket错误事件的回调

##### wx.onSocketMessage(callback)

监听 WebSocket 接受到服务器的消息事件

回调参数 res.data 服务器返回的消息

##### wx.onSocketClose(callback)

监听 WebSocket 连续关闭事件

- callback WebSocket 连续关闭事件的回调函数

##### wx.onSocketOpen(callback)

监听 WebSocket 连续打开事件

- callback 参数 res.header 连接成功的 HTTP 响应头

##### wx.sendSocketMessage(Object object)

通过 WebSocket 连接发送数据, 需要先 wx.connectSocket, 并在 wx.onSocketOpen 回调之后才能发送

- data   string/ArrayBuffer 需要发送的内容
- success 成功回调
- ...

```js
const socketOpen = false
const socketMsgQueue = []
wx.connectSocket({
    url: 'test.php'
})

wx.onSocketOpen(function (res) {
    socketOpen = true
    for (let i = 0; i < socketMsgQueue.length; i++) {
        sendSocketMessage(socketMsgQueue[i])
    }
    socketMsgQueue = []
})

function sendSocketMessage(msg) {
    if (socketOpen) {
        wx.sendSocketMessage({
            data: msg
        })
    } else {
        socketMsgQueue.push(msg)
    }
}
```

##### wx.closeSocket(Object object)

关闭 WebSocket 连接

- code	默认值1000(正常关闭连接)

- reason   可读字符串, 表示连接被关闭的原因. 字符串必须不长于123字节的 UTF-8文本
- success 成功回调
- ...

### mDns

##### wx.onLocalServiceResolveFail(callback)

监听 mDNS 服务解析失败的事件

- callback 回调

##### wx.onLocalServiceDiscoveryStop(callback)

监听 mDNS 服务停止搜索的事件

##### wx.onLocalServiceLost(callback)

监听 mDNS 服务离开的事件

- callback

  参数 res.serviceType	服务的类型

  参数 res.serviceName  服务的名称

##### wx.onLocalServiceFound(callback)

监听 mDNS 服务发现的事件

- callback

  参数 res.serviceType 服务的类型

  参数 res.serviceName 服务的名称

  参数 res.ip	服务的 ip 地址

  参数 res.port 服务的端口

## 数据缓存

##### wx.getStorageInfo(Object object)

异步获取当前 storage 的相关信息

- success 成功回调
  - keys 当前 storage 中所有的 key
  - currentSize 当前占用的空间大小
  - limitSize 限制的空间大小
- ...

##### wx.getStorageInfoSync()

是wx.getStorageInfo 同步版本

- keys  当前 storage 中所有的 key
- currentSize  当前占用的空间大小 KB
- limitSize  限制空间大小

实例代码

```js
wx.getStorageInfo({
    success(res) {
        console.log(res.keys)
        console.log(res.currentSize)
        console.log(res.limitSize)
    }
})

try {
    const res = wx.getStorageInfoSync()
    console.log(res.keys)
    console.log(res.currentSize)
    console.log(res.limitSize)
} catch (e) {
    // Do something when catch error
}
```























# mpvue

## 开始

**介绍**

1. 基于 vue.js 封装的用于开发小程序的框架

2. 融合原生小程序和 vue.js 的特点

3. 完全组件化

**特点**

1. 组件化开发
2. 完成的 vue.js 开发体验
3. 可使用 vuex 管理转台
4. webpack 构建项目
5. 最终 h5 转换工具将项目表编译成小程序识别的文件

### 初始化项目

1. npm install vue-cli -g 下载vue脚手架
2. vue init mpvue/mpvue-quickstart my-pro 初始化项目
3. cd my-pro 进入项目根目录

4. npm install 根据package.json 安装项目依赖
5. npm run dev/npm start 启动初始化项目

### 开启项目

npm run dev 后, 打开微信开发者工具, 对项目进程进行查看

## 基础

**事件绑定**

​	@tap = '事件名' 冒泡事件

​	@tap.stop = '事件名' 非冒泡事件



**注意事项: **

​	除了可以使用 vue 本身的生命周期外, mpvue 还兼容了小程序的生命周期, 这部分生命周期钩子来源于**微信小程序的 Page**, 除特殊情况外, 不建议使用小程序的生命周期钩子.

## flyio 使用(我这没用)

**axios 不支持微信小程序, 底层使用 window 对象的  HttpRequest 实现**

在小程序的开发, 我们选择使用 flyio 来实现数据的请求

**下载** 

​	**`npm install flyio -S`**	

**准备**

```js
//	引入
import Fly from 'flyio/dist/npm/wx'
//	实例化fly并挂载到全局 Vue 上
Vue.prototype.$fly = new Fly();
```

**基本使用**

```js
const urlLink = 'http://t.yushu.im/v2/movie/top250';
this.$fly.get(urlLink)
    .then((res)=>{
    	console.log(res);
	})
    .catch((err)=>{
    	console.log(err);
	})
```



## 生命周期



## Vuex 数据管理

![1543909065239](.\wx\1543909065239.png)

我们按照图示, 建立一下目录

```
|-store
	|-index.js
	|-state.js
	|-actions.js
	|-mutation-types.js
	|-mutations.js
	|-getters.js
```

index.js 导出模块, 在app 的 main.js  里挂载 store 进行数据管理

![1543909410453](.\wx\1543909410453.png)

![1543909448924](.\wx\1543909448924.png)

基本实现流程: 

1. state 负责定义数据初始状态
2. actions 负责请求数据, 并执行 commit 触发指定 mutations 

3. mutations 负责对数据状态进行更新操作
4. 在需要数据的视图中分发 action 执行指定数据的获取

![1543910090632](.\wx\1543910090632.png)





## 踩坑之路

### 编译坑

#### 未找到 app.json 入口

- 问题描述: mpvue编译后在微信开发者工具中未找到 app.json入口

- 解决方案:

  修改mpvue生成的目录下的 project.config.json 文件, 添加 **"miniprogramRoot": "dist/wx/"**

![1543852366114](.\wx\1543852366114.png)

#### 未找到 xxx.wxml

- 问题描述: 我们新建一个组件, 未找到 xxx.wxml

- 解决方案:

  新建组件不会及时帮我们编译到dist中, 所以**每当我们新建一个组件的时候,  需要重新执行 npm run dev**

### 事件坑

#### wx.navigateTo()

- 问题描述: wx.navigateTo() 跳转失效

- 解决方案:

  **wx.navigateTo() 不能应用于跳转至tabBar上挂载的页面, 如果需要, 则请使用 wx.switchTab()**



